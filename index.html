<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>虚拟开奖程序</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    .log { white-space: pre-wrap; background: #fff; padding: 15px; border: 1px solid #ccc; height: 400px; overflow-y: scroll; }
    input { padding: 5px; font-size: 16px; }
    button { padding: 5px 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>🎰 每30秒开奖 | 显示结果后可输入 | 自动预测下一轮</h2>
  <div class="log" id="log"></div>
  <div>
    <label for="userInput">⌨️ 请输入开奖号码（0-9）: </label>
    <input type="number" id="userInput" min="0" max="9">
    <button onclick="submitNumber()">提交</button>
  </div>

  <script>
    let roundNum = 1;
    let history = [];
    let lastPredicted = null;
    let inputAllowed = false;
    let timeoutId = null;

    function log(message) {
      const logDiv = document.getElementById("log");
      logDiv.innerText += message + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function getSize(num) {
      return num <= 4 ? "小" : "大";
    }

    function getColor(num) {
      if (num === 0) return ["红色", "紫色"];
      if (num === 5) return ["绿色", "紫色"];
      return num % 2 === 0 ? ["红色"] : ["绿色"]; // 奇数 → 绿色
    }

    function getColorIcon(color) {
      const icons = {
        "红色": "🔴",
        "绿色": "🟢",
        "紫色": "🟣"
      };
      return icons[color] || color;
    }

    function formatColorIcons(colors) {
      return colors.map(c => getColorIcon(c)).join(" ");
    }

    function predictNext(history) {
      if (history.length === 0) {
        const num = Math.floor(Math.random() * 10);
        return [num, getSize(num)];
      }
      const smallCount = history.filter(h => h && h[1] === "小").length;
      const bigCount = history.length - smallCount;
      const num = bigCount > smallCount ? rand(5, 9) : rand(0, 4);
      return [num, getSize(num)];
    }

    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function drawRound() {
      const now = new Date();
      const timeStr = now.toTimeString().split(" ")[0];
      log(`\n⏰ 第 ${roundNum} 轮开奖时间 - ${timeStr}`);
      log("🎲 正在开奖中……");
      inputAllowed = true;

      timeoutId = setTimeout(() => {
        if (inputAllowed) {
          log("⚠️ 未输入或输入无效，本轮跳过（未记录开奖号码）");
          history.push(null);
          afterDraw();
        }
      }, 15000);
    }

    function submitNumber() {
      if (!inputAllowed) return;
      const input = document.getElementById("userInput").value;
      const num = parseInt(input);
      if (!isNaN(num) && num >= 0 && num <= 9) {
        clearTimeout(timeoutId);
        const size = getSize(num);
        const colors = getColor(num);
        log(`🎯 开奖结果：${num} -> ${size} | 颜色：${formatColorIcons(colors)}`);
        history.push([num, size, colors]);
        inputAllowed = false;
        afterDraw();
      } else {
        log("⚠️ 输入无效，请输入 0-9 的数字");
      }
    }

    function afterDraw() {
      const cleanHistory = history.filter(entry => entry !== null);
      const [predictedNum, predictedSize] = predictNext(cleanHistory);
      const predictedColors = getColor(predictedNum);

      log(`🔮 预测第 ${roundNum + 1} 轮号码：${predictedNum} -> ${predictedSize} | 颜色：${formatColorIcons(predictedColors)}`);
      log(`----------------------`);

      // 比对预测（本轮开奖结果 vs 上一轮预测）
      if (lastPredicted !== null && history.length >= 1) {
        const lastActual = history[history.length - 1];
        if (lastActual) {
          const [actualNum, actualSize, actualColors] = lastActual;
          const [predNum, predSize] = lastPredicted;
          const predColors = getColor(predNum);

          const matchNumber = actualNum === predNum ? "✅" : "❌";
          const matchSize = actualSize === predSize ? "✅" : "❌";
          const matchColor = predColors.some(c => actualColors.includes(c)) ? "✅" : "❌";

          log(`📋 上轮预测结果：`);
          log(`号码：${predNum} ${matchNumber}`);
          log(`颜色：${formatColorIcons(predColors)} ${matchColor}`);
          log(`大小：${predSize} ${matchSize}`);
        } else {
          log("📋 上轮预测结果：无开奖数据，无法比对");
        }
      }

      lastPredicted = [predictedNum, predictedSize];
      roundNum += 1;
    }

    // 每秒检查一次是否到 30 秒时点，触发 drawRound()
    setInterval(() => {
      const now = new Date();
      if (now.getSeconds() % 30 === 0) {
        drawRound();
      }
    }, 1000);
  </script>
</body>
</html>
